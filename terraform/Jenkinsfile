pipeline {
  agent any

  environment {
    TF_CLOUD_TOKEN = credentials('tf_backend_token')
    YC_ZONE = credentials('yc_zone')
    YC_CLOUD_ID = credentials('yc_cloud_id')
    YC_FOLDER_ID = credentials('yc_folder_id')
    YC_TOKEN = credentials('yc_token')
    PB_SSH_KEYS = credentials('pb_ssh_keys')
    PVT_SSH_KEY = credentials('pvt_ssh_key')
  }

  tools {
    terraform 'terraform14'
  }

  stages {
    stage('Checkout') {
      steps {
        checkout scm
      }
    }

    stage('TF Init') {
      steps {
        sh 'terraform -chdir=./terraform init'
        }
      }      

    stage('TF Plan') {
      steps {
        sh 'terraform -chdir=./terraform plan -var "tf_backend_token=${TF_CLOUD_TOKEN}" -var "pb_ssh_keys=${PB_SSH_KEYS}" -var "pvt_ssh_key=${PVT_SSH_KEY}"'
      }
    }
  }
  post {
    always {
      cleanWs()
    }
  }
}